name: Windows-RDP-Optimized

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 1. Instalar Ngrok
        run: |
          choco install ngrok
          
      - name: 2. Autenticar Ngrok
        run: |
          # Usamos el secreto guardado en GitHub
          ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: 3. Configurar Windows y RDP
        run: |
          # Configurar usuario y contrase帽a (C谩mbiala si lo deseas)
          $password = "Pass12345!"
          net user runneradmin $password
          
          # Habilitar Escritorio Remoto en el Registro
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

      - name: 4. Iniciar T煤nel Ngrok
        run: |
          # Iniciamos el proceso y le damos un momento para arrancar
          Start-Process ngrok -ArgumentList "tcp 3389"
          Start-Sleep -Seconds 5

      - name: 5. Obtener Direcci贸n de Conexi贸n
        shell: powershell
        run: |
          $url = ""
          Write-Host "Buscando t煤nel activo..."
          
          # Bucle de 20 intentos (aprox. 100 segundos)
          for ($i=1; $i -le 20; $i++) {
            try {
              # Consultamos la API local de Ngrok para obtener la URL p煤blica
              $response = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
              $url = $response.tunnels[0].public_url
              
              if ($url) {
                $clean_url = $url.Replace("tcp://", "")
                Write-Host "=========================================="
                Write-Host " 隆LISTO PARA CONECTAR!"
                Write-Host "DIRECCIN RDP: $clean_url"
                Write-Host "USUARIO: runneradmin"
                Write-Host "CONTRASEA: Pass12345!"
                Write-Host "=========================================="
                return # Salimos con 茅xito
              }
            } catch {
              Write-Host "Esperando respuesta de la API de Ngrok... (Intento $i/20)"
            }
            Start-Sleep -Seconds 5
          }

          # Si el bucle termina sin URL, forzamos el error
          Write-Error "ERROR: No se pudo obtener la URL. Verifica tu NGROK_AUTH_TOKEN."
          exit 1

      - name: 6. Mantener Sesi贸n Viva (6 Horas)
        run: |
          Write-Host "La sesi贸n RDP est谩 activa. No cierres este workflow."
          # Loop de espera para mantener el runner encendido
          $timeout = 360 # 360 minutos = 6 horas
          for ($i=1; $i -le $timeout; $i++) {
             Write-Host "Minuto $i de $timeout - Sesi贸n activa..."
             Start-Sleep -Seconds 60
          }
