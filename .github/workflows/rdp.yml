name: Windows-RDP

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Instalar Ngrok v√≠a Chocolatey
        run: |
          choco install ngrok
          
      - name: Autenticar Ngrok
        run: |
          ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Configurar Usuario y RDP
        run: |
          # Cambiamos la contrase√±a al usuario runneradmin
          net user runneradmin Pass12345!
          # Activamos el servicio de Escritorio Remoto
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

      - name: Crear T√∫nel
        run: |
          # Iniciamos el proceso de Ngrok en segundo plano
          Start-Process powershell -ArgumentList "-NoExit -Command 'ngrok tcp 3389'"

      - name: Obtener Direcci√≥n IP de Conexi√≥n
        run: |
          $url = ""
          echo "Esperando a que el t√∫nel de Ngrok est√© listo..."
          
          # Bucle de reintento (12 intentos cada 5 segundos = 1 minuto de margen)
          for ($i=1; $i -le 12; $i++) {
            try {
              $tunnels = curl.exe --silent http://127.0.0.1:4040/api/tunnels | ConvertFrom-Json
              $url = $tunnels.tunnels[0].public_url
              if ($url) { break }
            } catch { }
            Write-Host "Buscando direcci√≥n... Intento $i/12"
            Start-Sleep -Seconds 5
          }

          if ($url) {
            $clean_url = $url.Replace("tcp://", "")
            Write-Host "=========================================="
            Write-Host "üöÄ ¬°LISTO PARA CONECTAR!"
            Write-Host "DIRECCI√ìN (IP): $clean_url"
            Write-Host "USUARIO: runneradmin"
            Write-Host "CONTRASE√ëA: Pass12345!"
            Write-Host "=========================================="
          } else {
            Write-Host "‚ùå ERROR: No se pudo obtener la URL. Revisa tu NGROK_AUTH_TOKEN en Secrets."
            exit 1
          }

      - name: Mantener Vivo (6 horas)
        run: |
          Write-Host "La sesi√≥n RDP est√° activa. No cierres este workflow."
          Start-Sleep -Seconds 21600
