name: Windows-RDP-Secure

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Setup Ngrok
        run: |
          choco install ngrok
          ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Enable RDP & Set User
        run: |
          # Use a secret for the password to be safe!
          $password = "Pass12345!" 
          net user runneradmin $password
          
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

      - name: Create Tunnel
        run: |
          # Start Ngrok and redirect output to avoid hanging the step
          Start-Process ngrok -ArgumentList "tcp 3389"

      - name: Connection Details
        run: |
          $attempts = 0
          while ($attempts -lt 10) {
            try {
              $response = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels"
              $url = $response.tunnels[0].public_url
              if ($url) {
                $clean_url = $url.Replace("tcp://", "")
                Write-Host "=========================================="
                Write-Host "ðŸš€ CONNECTION INFO"
                Write-Host "ADDRESS: $clean_url"
                Write-Host "USER: runneradmin"
                Write-Host "=========================================="
                return
              }
            } catch { }
            $attempts++
            Start-Sleep -Seconds 5
          }
          Write-Error "Failed to get Ngrok URL."

      - name: Keep Alive
        run: |
          Write-Host "RDP Active. Session will timeout in 6 hours or if manually cancelled."
          # Loop to keep the runner busy without being totally silent
          for ($i=1; $i -le 360; $i++) {
             Write-Host "Session active... ($i/360 minutes)"
             Start-Sleep -Seconds 60
          }
